<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>SHSSM Newsletter Inaugural Issue</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #5c4033;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .flipbook-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .book-wrapper {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1;
            width: 100%;
            overflow: hidden;
            transform-origin: center center;
            transition: transform 0.3s ease;
            touch-action: manipulation;
        }

        #flipbook {
            margin: 0 auto;
            position: relative;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .page {
            background: white;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            transform-origin: center center;
        }

        .page img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 4px;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        /* Simplified hover effects for mobile */
        .page.hover-left {
            transform: translateX(2px) scale(1.01);
            box-shadow: 2px 4px 8px rgba(0, 0, 0, 0.25);
            z-index: 5;
        }
        
        .page.hover-right {
            transform: translateX(-2px) scale(1.01);
            box-shadow: -2px 4px 8px rgba(0, 0, 0, 0.25);
            z-index: 5;
        }
        
        /* Mobile-optimized drag feedback */
        .page.tilting-left {
            transform: translateX(8px) scale(1.02);
            box-shadow: 4px 6px 12px rgba(0, 0, 0, 0.3);
            z-index: 15;
            filter: brightness(1.05);
        }
        
        .page.tilting-right {
            transform: translateX(-8px) scale(1.02);
            box-shadow: -4px 6px 12px rgba(0, 0, 0, 0.3);
            z-index: 15;
            filter: brightness(1.05);
        }
        
        .page.tilting-strong-left {
            transform: translateX(15px) scale(1.05);
            box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.4);
            z-index: 20;
            filter: brightness(1.1);
        }
        
        .page.tilting-strong-right {
            transform: translateX(-15px) scale(1.05);
            box-shadow: -8px 8px 20px rgba(0, 0, 0, 0.4);
            z-index: 20;
            filter: brightness(1.1);
        }

        .book-wrapper.grabbing,
        .book-wrapper.grabbing .page {
            cursor: grabbing !important;
        }

        /* Touch-friendly hover zones */
        .page::before,
        .page::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 60px;
            z-index: 1;
            pointer-events: none;
            transition: background 0.3s ease;
        }

        .page::before {
            left: 0;
            background: linear-gradient(to right, rgba(0, 0, 0, 0.02), transparent);
        }

        .page::after {
            right: 0;
            background: linear-gradient(to left, rgba(0, 0, 0, 0.02), transparent);
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 14px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            touch-action: manipulation;
            min-width: 80px;
            min-height: 48px;
        }

        .control-btn:hover,
        .control-btn:active {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .zoom-controls {
            position: fixed;
            top: 20px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .zoom-btn {
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.4em;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            touch-action: manipulation;
        }

        .zoom-btn:hover,
        .zoom-btn:active {
            background: rgba(255, 255, 255, 0.35);
            transform: scale(1.05);
        }

        .zoom-level {
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            text-align: center;
            backdrop-filter: blur(10px);
            min-width: 55px;
        }

        .page-info {
            position: fixed;
            top: 20px;
            left: 15px;
            background: rgba(255, 255, 255, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.4);
            color: white;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }

        /* Turn.js specific styles */
        .turn-page {
            background-color: white;
            background-size: 100% 100%;
        }

        /* Loading indicator */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: #666;
            font-size: 0.9em;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #666;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .page.loading .loading-indicator {
            display: flex;
        }

        .page:not(.loading) .loading-indicator {
            display: none;
        }

        /* Image placeholder */
        .image-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.9em;
            position: absolute;
            top: 0;
            left: 0;
        }

        .page:not(.loading) .image-placeholder {
            display: none;
        }

        /* Progress bar */
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: rgba(255, 255, 255, 0.2);
            z-index: 1001;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-container.hidden {
            display: none;
        }

        /* Mobile-specific optimizations */
        @media (max-width: 768px) {
            .flipbook-container {
                padding: 5px;
            }
            
            .controls {
                bottom: 15px;
                gap: 12px;
            }
            
            .control-btn {
                padding: 12px 20px;
                font-size: 0.9em;
                min-height: 44px;
            }
            
            .zoom-controls {
                top: 15px;
                right: 10px;
                gap: 6px;
            }
            
            .zoom-btn {
                width: 44px;
                height: 44px;
                font-size: 1.2em;
            }
            
            .page-info {
                top: 15px;
                left: 10px;
                padding: 8px 14px;
                font-size: 0.85em;
            }

            .zoom-level {
                font-size: 0.8em;
                padding: 6px 10px;
            }
        }

        /* Landscape mobile adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .controls {
                bottom: 10px;
            }
            
            .zoom-controls {
                top: 10px;
                right: 8px;
            }
            
            .page-info {
                top: 10px;
                left: 8px;
            }
        }

        /* Very small screens */
        @media (max-width: 480px) {
            .control-btn {
                padding: 10px 16px;
                font-size: 0.85em;
                min-height: 40px;
            }
            
            .zoom-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1em;
            }
            
            .page-info {
                padding: 6px 12px;
                font-size: 0.8em;
            }
        }
    </style>
</head>
<body>

<div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
</div>

<div class="flipbook-container">
    <div class="page-info" id="pageInfo">Page 1 of 32</div>
    
    <div class="zoom-controls">
        <button class="zoom-btn" id="zoomInBtn">+</button>
        <div class="zoom-level" id="zoomLevel">100%</div>
        <button class="zoom-btn" id="zoomOutBtn">-</button>
        <button class="zoom-btn" id="resetBtn">⌂</button>
    </div>
    
    <div class="book-wrapper" id="bookWrapper">
        <div id="flipbook">
            </div>
    </div>
    
    <div class="controls">
        <button class="control-btn" id="prevBtn">← Previous</button>
        <button class="control-btn" id="nextBtn">Next →</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
    
<script>
    $(document).ready(function() {
        // Configuration
        const TOTAL_PAGES = 32;
        const PRELOAD_RANGE = 3; // Reduced for mobile performance
        const IMAGE_BASE_PATH = 'images/';
        const IMAGE_EXTENSION = '.png';
        const EDGE_HOVER_THRESHOLD = 80; // Larger for touch devices
        
        // Device detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        
        // State variables
        let currentZoom = 1;
        
        // Pan/drag state
        let isPanning = false;
        let panStartX, panStartY, panOffsetX = 0, panOffsetY = 0;

        // Drag-to-flip state
        let isDraggingToFlip = false;
        let dragStartX, dragCurrentX;
        let dragStartTime;
        
        // Touch handling
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false;
        
        // Image loading management
        const loadedImages = new Map();
        const loadingQueue = new Set();
        let totalImagesLoaded = 0;
        
        // jQuery Element Cache
        const $flipbook = $("#flipbook");
        const $bookWrapper = $("#bookWrapper");
        const $progressBar = $("#progressBar");
        const $progressContainer = $("#progressContainer");
        const $pageInfo = $("#pageInfo");
        const $prevBtn = $("#prevBtn");
        const $nextBtn = $("#nextBtn");
        const $zoomInBtn = $("#zoomInBtn");
        const $zoomOutBtn = $("#zoomOutBtn");
        const $resetBtn = $("#resetBtn");
        const $zoomLevel = $("#zoomLevel");

        // --- Utility Functions ---

        function getEventX(e) {
            return e.type.includes('touch') ? e.touches[0]?.clientX || e.changedTouches[0]?.clientX : e.clientX;
        }

        function getEventY(e) {
            return e.type.includes('touch') ? e.touches[0]?.clientY || e.changedTouches[0]?.clientY : e.clientY;
        }

        // --- Page and Image Loading ---

        function generatePages() {
            for (let i = 1; i <= TOTAL_PAGES; i++) {
                const pageTitle = i === 1 ? 'Cover Page' : i === TOTAL_PAGES ? 'Back Cover' : `Page ${i}`;
                const pageHTML = `
                    <div class="page loading" data-page="${i}">
                        <div class="image-placeholder">Page ${i}</div>
                        <div class="loading-indicator">
                            <div class="spinner"></div>
                            <div>Loading...</div>
                        </div>
                        <img data-src="${IMAGE_BASE_PATH}Page-${i.toString().padStart(2, '0')}${IMAGE_EXTENSION}" 
                             alt="${pageTitle}" style="display: none;">
                    </div>`;
                $flipbook.append(pageHTML);
            }
        }

        function updateProgress() {
            const progress = TOTAL_PAGES > 0 ? (totalImagesLoaded / TOTAL_PAGES) * 100 : 0;
            $progressBar.css('width', `${progress}%`);
            if (totalImagesLoaded >= TOTAL_PAGES) {
                setTimeout(() => $progressContainer.addClass('hidden'), 500);
            }
        }

        function loadImage(pageNumber) {
            if (!pageNumber || loadedImages.has(pageNumber) || loadingQueue.has(pageNumber)) return;
            loadingQueue.add(pageNumber);
            const page = $(`.page[data-page="${pageNumber}"]`);
            if (!page.length) {
                loadingQueue.delete(pageNumber);
                return;
            }

            const imgElement = page.find('img');
            const imgSrc = imgElement.data('src');
            const image = new Image();
            image.onload = () => {
                imgElement.attr('src', imgSrc).show();
                page.removeClass('loading');
                loadedImages.set(pageNumber, true);
                loadingQueue.delete(pageNumber);
                totalImagesLoaded++;
                updateProgress();
            };
            image.onerror = () => {
                page.removeClass('loading').addClass('error');
                loadingQueue.delete(pageNumber);
                console.error(`Failed to load image for page ${pageNumber}: ${imgSrc}`);
            };
            image.src = imgSrc;
        }

        function preloadPages(centerPage) {
            for (let i = Math.max(1, centerPage - PRELOAD_RANGE); i <= Math.min(TOTAL_PAGES, centerPage + PRELOAD_RANGE); i++) {
                loadImage(i);
            }
        }

        // --- Flipbook Sizing and Initialization ---

        function calculateOptimalSize() {
            const viewportWidth = $(window).width();
            const viewportHeight = $(window).height();
            const aspectRatio = 8.3 / 11.7;

            // More conservative sizing for mobile
            const widthMultiplier = isMobile ? 0.95 : 0.9;
            const heightMultiplier = isMobile ? 0.8 : 0.9;

            let bookWidth = viewportWidth * widthMultiplier;
            let bookHeight = bookWidth / (2 * aspectRatio);

            if (bookHeight > viewportHeight * heightMultiplier) {
                bookHeight = viewportHeight * heightMultiplier;
                bookWidth = bookHeight * (2 * aspectRatio);
            }

            return { width: Math.floor(bookWidth), height: Math.floor(bookHeight) };
        }
        
        function initializeFlipbook() {
            const size = calculateOptimalSize();
            $flipbook.turn({
                width: size.width,
                height: size.height,
                elevation: isMobile ? 25 : 50, // Reduced elevation for mobile performance
                gradients: !isMobile, // Disable gradients on mobile for performance
                autoCenter: true,
                duration: isMobile ? 600 : 800, // Faster animations on mobile
                acceleration: !isMobile,
                when: {
                    turned: (event, page, view) => {
                        view.forEach(p => preloadPages(p));
                        updateControls();
                    }
                }
            });
            updateControls();
        }

        function resizeFlipbook() {
            const size = calculateOptimalSize();
            $flipbook.turn("size", size.width, size.height);
        }

        // --- UI Updates ---

        function updateControls() {
            const currentPage = $flipbook.turn('page');
            $pageInfo.text(`Page ${currentPage} of ${TOTAL_PAGES}`);
            $prevBtn.prop("disabled", currentPage <= 1);
            $nextBtn.prop("disabled", currentPage >= TOTAL_PAGES);
        }

        function updateZoom() {
            if (currentZoom === 1) {
                panOffsetX = 0; panOffsetY = 0;
            }
            $bookWrapper.css({
                transform: `scale(${currentZoom}) translate(${panOffsetX}px, ${panOffsetY}px)`,
                cursor: currentZoom > 1 ? "grab" : "default"
            });
            $zoomLevel.text(`${Math.round(currentZoom * 100)}%`);
            $zoomOutBtn.prop("disabled", currentZoom <= 0.5);
            $zoomInBtn.prop("disabled", currentZoom >= 2.0);
            $resetBtn.prop("disabled", currentZoom === 1 && panOffsetX === 0 && panOffsetY === 0);
        }
        
        function clearTiltEffects() {
            $(".page").removeClass("tilting-left tilting-right tilting-strong-left tilting-strong-right hover-left hover-right");
        }

        function handleEdgeHover(clientX) {
            if (isDraggingToFlip || isPanning || currentZoom > 1) return;
            
            const bookRect = $flipbook[0].getBoundingClientRect();
            const leftEdge = bookRect.left;
            const rightEdge = bookRect.right;
            
            clearTiltEffects();
            
            const currentPage = $flipbook.turn('page');
            
            // Left edge hover (for previous page)
            if (clientX - leftEdge < EDGE_HOVER_THRESHOLD && currentPage > 1) {
                const $currentPageEl = $flipbook.find('.page[data-page="' + currentPage + '"]');
                $currentPageEl.addClass('hover-left');
            }
            // Right edge hover (for next page)
            else if (rightEdge - clientX < EDGE_HOVER_THRESHOLD && currentPage < TOTAL_PAGES) {
                const targetPageNumber = (currentPage === 1) ? 1 : currentPage + 1;
                const $targetPageEl = $flipbook.find('.page[data-page="' + targetPageNumber + '"]');
                $targetPageEl.addClass('hover-right');
            }
        }

        // --- Unified Pointer Handling Functions ---

        function handlePointerStart(e) {
            const clientX = getEventX(e);
            const clientY = getEventY(e);
            
            if (currentZoom > 1) {
                isPanning = true;
                panStartX = clientX - panOffsetX;
                panStartY = clientY - panOffsetY;
                $bookWrapper.addClass('grabbing');
            } else {
                isDraggingToFlip = true;
                dragStartX = dragCurrentX = clientX;
                dragStartTime = Date.now();
                $bookWrapper.addClass('grabbing');
                clearTiltEffects();
            }
        }

        function handlePointerMove(e) {
            const clientX = getEventX(e);
            const clientY = getEventY(e);
            
            if (isPanning) {
                panOffsetX = clientX - panStartX;
                panOffsetY = clientY - panStartY;
                updateZoom();
            } else if (isDraggingToFlip) {
                dragCurrentX = clientX;
                const deltaX = dragCurrentX - dragStartX;
                const dragStrength = Math.abs(deltaX);
                let pageToTilt = null;
                let isStrongDrag = dragStrength > 80; // Adjusted for touch

                clearTiltEffects();
                
                const currentPage = $flipbook.turn('page');

                // Dragging RIGHT (to go to PREVIOUS page)
                if (deltaX > 15 && currentPage > 1) {
                    pageToTilt = $flipbook.find('.page[data-page="' + currentPage + '"]');
                    if (pageToTilt.length) {
                        pageToTilt.addClass(isStrongDrag ? 'tilting-strong-left' : 'tilting-left');
                    }
                } 
                // Dragging LEFT (to go to NEXT page)
                else if (deltaX < -15 && currentPage < TOTAL_PAGES) {
                    const targetPageNumber = (currentPage === 1) ? 1 : currentPage + 1;
                    pageToTilt = $flipbook.find('.page[data-page="' + targetPageNumber + '"]');
                    if (pageToTilt.length) {
                        pageToTilt.addClass(isStrongDrag ? 'tilting-strong-right' : 'tilting-right');
                    }
                }
            }
        }

        function handlePointerEnd(e) {
            const clientX = getEventX(e);
            
            if (isDraggingToFlip) {
                const deltaX = dragCurrentX - dragStartX;
                const duration = Date.now() - dragStartTime;

                // For touch devices, be more sensitive to swipes
                const swipeThreshold = isTouch ? 30 : 50;
                const maxDuration = isTouch ? 800 : 500;

                if (Math.abs(deltaX) > swipeThreshold && duration < maxDuration) {
                    if (deltaX > 0) {
                        $flipbook.turn("previous");
                    } else {
                        $flipbook.turn("next");
                    }
                } else if (Math.abs(deltaX) < 10 && !touchMoved) {
                    // Handle tap/click
                    const bookRect = $flipbook[0].getBoundingClientRect();
                    if (clientX < bookRect.left + bookRect.width / 2) {
                        $flipbook.turn("previous");
                    } else {
                        $flipbook.turn("next");
                    }
                }
                clearTiltEffects();
            }

            isPanning = false;
            isDraggingToFlip = false;
            touchMoved = false;
            $bookWrapper.removeClass('grabbing');
        }

        // --- Event Handlers ---

        // Mouse Events (enabled for all devices)
        $flipbook.on('mousemove', function(e) {
            if (!isDraggingToFlip && !isPanning) {
                handleEdgeHover(e.clientX);
            }
        });
        
        $flipbook.on('mouseleave', function() {
            if (!isDraggingToFlip && !isPanning) {
                clearTiltEffects();
            }
        });

        // Unified mouse and touch events
        $bookWrapper.on('mousedown touchstart', function(e) {
            if (e.type === 'mousedown' && e.button !== 0) return; // Only left mouse button
            
            e.preventDefault();
            
            if (e.type === 'touchstart') {
                touchMoved = false;
                touchStartX = getEventX(e);
                touchStartY = getEventY(e);
            }
            
            handlePointerStart(e);
        });

        $(document).on('mousemove touchmove', function(e) {
            if (!isPanning && !isDraggingToFlip) return;
            
            e.preventDefault();
            
            if (e.type === 'touchmove') {
                const touchX = getEventX(e);
                const touchY = getEventY(e);
                const deltaX = Math.abs(touchX - touchStartX);
                const deltaY = Math.abs(touchY - touchStartY);
                
                if (deltaX > 10 || deltaY > 10) {
                    touchMoved = true;
                }
            }
            
            handlePointerMove(e);
        });

        $(document).on('mouseup touchend touchcancel', function(e) {
            if (!isPanning && !isDraggingToFlip) return;
            
            e.preventDefault();
            handlePointerEnd(e);
        });

        // Button Controls & Keyboard
        $prevBtn.on('click touchend', function(e) {
            e.preventDefault();
            $flipbook.turn("previous");
        });
        
        $nextBtn.on('click touchend', function(e) {
            e.preventDefault();
            $flipbook.turn("next");
        });
        
        $zoomInBtn.on('click touchend', function(e) {
            e.preventDefault();
            currentZoom = Math.min(2.0, currentZoom + 0.1);
            updateZoom();
        });
        
        $zoomOutBtn.on('click touchend', function(e) {
            e.preventDefault();
            currentZoom = Math.max(0.5, currentZoom - 0.1);
            updateZoom();
        });
        
        $resetBtn.on('click touchend', function(e) {
            e.preventDefault();
            currentZoom = 1;
            panOffsetX = 0;
            panOffsetY = 0;
            updateZoom();
        });

        // Keyboard support (desktop only)
        if (!isMobile) {
            $(document).on('keydown', function(e) {
                if (e.key === "ArrowLeft") $flipbook.turn("previous");
                else if (e.key === "ArrowRight") $flipbook.turn("next");
            });
        }
        
        // Window Resize
        $(window).on('resize orientationchange', function() {
            setTimeout(resizeFlipbook, 100);
        });

        // Prevent default touch behaviors
        $(document).on('touchmove', function(e) {
            if ($(e.target).closest('.flipbook-container').length) {
                e.preventDefault();
            }
        }, { passive: false });

        // --- Initialization ---
        generatePages();
        initializeFlipbook();
        updateZoom();
        preloadPages(1);
        preloadPages(2);
    });
</script>
